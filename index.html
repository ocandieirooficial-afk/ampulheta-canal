<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Estúdios Candieiro — Painel</title>
<link rel="icon" href="/assets/logo.png">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@700&display=swap" rel="stylesheet">
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg1:#0b0b0d; --bg2:#1a0f12; --bg3:#231218;
  --panel:#121720; --line:#213047;
  --ink:#e9edf3; --muted:#9fb0c8;
  --accent:#ffcc00; --accent2:#fff07a;
  --ok:#39d98a; --warn:#ffd166; --bad:#ff6b6b; --blue:#78b9ff;
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--ink);
  font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
  background:
    radial-gradient(1200px 800px at 70% 20%, rgba(218,45,64,.08), rgba(0,0,0,0)),
    linear-gradient(160deg, var(--bg1) 0%, var(--bg2) 60%, var(--bg3) 100%);
}
.wrap{max-width:1060px;margin:28px auto 48px;padding:0 16px}
.top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:16px}
.logo{display:flex;align-items:center;gap:12px}
.logo img{width:36px;height:36px;border-radius:8px}
.sub{color:var(--muted);font-size:13px}
.avatar-sm{width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}

.tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px}
.tabs label{display:inline-block;background:#151e2c;border:1px solid var(--line);color:#cfe6ff;padding:8px 12px;border-radius:10px;cursor:pointer}
.tabs input{display:none}
.tabs input:checked + label{background:linear-gradient(90deg,var(--accent),var(--accent2));color:#222;border-color:#d4b100}

.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:18px;margin-bottom:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
.row{display:flex;gap:16px;flex-wrap:wrap}
.row .card{flex:1 1 280px}

.pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#0f1420;border:1px solid var(--line);color:#9fb0c8;font-size:12px}
.big{font-size:34px;font-weight:800;letter-spacing:.2px}
.bar{height:12px;background:#0e1420;border:1px solid var(--line);border-radius:999px;overflow:hidden}
.bar>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));transition:width .6s ease}

.select,input,textarea{width:100%;background:#0e1420;color:#cfe6ff;border:1px solid var(--line);border-radius:10px;padding:10px}
label.field{display:block;font-size:12px;color:#9fb0c8;margin:6px 0 4px}

.progress-steps{display:grid;grid-template-columns:repeat(6,1fr);gap:10px;margin-top:10px}
.step{background:#0f1420;border:1px solid var(--line);border-radius:10px;padding:10px;text-align:center}
.step .s-title{font-size:12px;color:#a9bdd7}
.step .s-time{font-size:12px;color:#7ea0d1}

.bars{display:flex;gap:8px;align-items:flex-end;height:120px;margin-top:8px}
.bars .col{flex:1;background:linear-gradient(180deg,#ffcc00,#ffd84d);border:1px solid #d7b000;border-radius:6px 6px 0 0;min-width:28px;display:flex;align-items:flex-end;justify-content:center;color:#1d1700;font-weight:700}
.bars .col small{display:block;padding:6px 2px}
.bars .col.muted{background:linear-gradient(180deg,#243146,#1a232f);border-color:#1f2a3d;color:#a9bdd7}

table{width:100%;border-collapse:collapse;font-size:14px}
th,td{padding:10px;border-bottom:1px dashed #223046;text-align:left}
th{color:#a9bdd7;font-weight:600}

.list ul{padding-left:18px} .small{font-size:12px} .muted{color:#9fb0c8}

/* painéis das abas (CSS-only) */
.panels>section{display:none}
#tab-dashboard:checked ~ .panels #panel-dashboard{display:block}
#tab-editor:checked ~ .panels #panel-editor{display:block}
#tab-pesquisa:checked ~ .panels #panel-pesquisa{display:block}
#tab-roteiros:checked ~ .panels #panel-roteiros{display:block}
#tab-fontes:checked ~ .panels #panel-fontes{display:block}
#tab-metas:checked ~ .panels #panel-metas{display:block}
#tab-historico:checked ~ .panels #panel-historico{display:block}
</style>
</head>
<body>
<section class="wrap">
  <div class="top">
    <div class="logo">
      <img src="/assets/logo.png" alt="logo" onerror="this.style.display='none'">
      <div>
        <div style="font-weight:800">Estúdios Candieiro</div>
        <div class="sub">Painel de Produção — America/Fortaleza</div>
      </div>
    </div>
    <img src="/assets/paulo.jpg" class="avatar-sm" alt="Paulo" onerror="this.style.display='none'">
  </div>

  <!-- TABS CSS-ONLY -->
  <div class="tabs">
    <input type="radio" name="tabs" id="tab-dashboard" checked>
    <label for="tab-dashboard">Dashboard</label>

    <input type="radio" name="tabs" id="tab-editor">
    <label for="tab-editor">Editor</label>

    <input type="radio" name="tabs" id="tab-pesquisa">
    <label for="tab-pesquisa">Pesquisa</label>

    <input type="radio" name="tabs" id="tab-roteiros">
    <label for="tab-roteiros">Roteiros</label>

    <input type="radio" name="tabs" id="tab-fontes">
    <label for="tab-fontes">Fontes</label>

    <input type="radio" name="tabs" id="tab-metas">
    <label for="tab-metas">Metas</label>

    <input type="radio" name="tabs" id="tab-historico">
    <label for="tab-historico">Histórico</label>
  </div>

  <div class="panels">
    <!-- DASHBOARD -->
    <section id="panel-dashboard">
      <div class="row">
        <div class="card" style="flex:2">
          <div class="pill">Produção</div>
          <label class="field">Selecionar produção</label>
          <select id="selProd" class="select"></select>
          <div id="steps" class="progress-steps"></div>
        </div>
        <div class="card" style="flex:1">
          <div class="pill">Próximo vídeo em</div>
          <div id="countdown" class="big" style="margin:8px 0 6px">--:--:--</div>
          <div id="nextLabel" class="muted small">Carregando…</div>
          <div class="pill" style="margin-top:12px">Entre lançamentos</div>
          <div class="bar" style="margin:8px 0"><span id="progress"></span></div>
          <div id="progressLabel" class="muted small">—</div>
        </div>
      </div>

      <div class="row">
        <div class="card">
          <div class="pill">Ritmo semanal</div>
          <div id="bars" class="bars"></div>
          <p class="small muted">Publicações por semana (últimas 6 semanas)</p>
        </div>
        <div class="card">
          <div class="pill">Workflow em andamento</div>
          <ul id="flowList" class="small muted" style="line-height:1.9"></ul>
        </div>
      </div>

      <div class="card">
        <div class="pill">Linha do tempo</div>
        <ul id="timeline" class="list"></ul>
      </div>
    </section>

    <!-- EDITOR -->
    <section id="panel-editor">
      <div class="card">
        <div class="pill">Cadastrar/Editar Produção (salva automaticamente)</div>
        <form id="form" onsubmit="return false" style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:12px 0">
          <div><label class="field">Título</label><input id="fTitulo" placeholder="Narrativas: Chico Mendes"></div>
          <div><label class="field">Selo</label>
            <select id="fSelo" class="select">
              <option>Narrativas</option><option>Arquivo Criminal</option><option>Inexplicável</option><option>Prévia</option><option>Abertos</option>
            </select>
          </div>
          <div><label class="field">Data & hora (YYYY-MM-DDTHH:MM)</label><input id="fData" placeholder="2025-11-14T18:00"></div>
          <div><label class="field">Link (opcional)</label><input id="fLink" placeholder="https://..."></div>

          <div style="grid-column:1/-1"><div class="pill">Roteiro (PDF)</div></div>
          <div><label class="field">Anexar PDF</label><input id="fPDF" type="file" accept="application/pdf"></div>
          <div><label class="field">Notas do Roteiro</label><input id="fNotas" placeholder="Observações"></div>

          <div style="grid-column:1/-1"><div class="pill">Avaliação do Roteiro</div></div>
          <div><label class="field">Força Narrativa</label><input id="rForca" type="number" min="1" max="5" value="4"></div>
          <div><label class="field">Impacto Emocional</label><input id="rEmocional" type="number" min="1" max="5" value="4"></div>
          <div><label class="field">Carga dramática & Sensibilidade</label><input id="rDrama" type="number" min="1" max="5" value="4"></div>
          <div><label class="field">Credibilidade</label><input id="rCred" type="number" min="1" max="5" value="4"></div>
          <div><label class="field">Originalidade</label><input id="rOrig" type="number" min="1" max="5" value="4"></div>

          <div style="grid-column:1/-1"><div class="pill">Workflow da Produção</div></div>
          <div><label><input type="checkbox" id="wPesquisa"> Pesquisa</label></div>
          <div><label><input type="checkbox" id="wRoteiro"> Roteiro</label></div>
          <div><label><input type="checkbox" id="wGravacao"> Gravação</label></div>
          <div><label><input type="checkbox" id="wDecupagem"> Decupagem</label></div>
          <div><label><input type="checkbox" id="wEdicao"> Edição</label></div>
          <div><label><input type="checkbox" id="wPostagem"> Postagem</label></div>

          <div style="grid-column:1/-1"><div class="pill">Pesquisa (links)</div></div>
          <div style="grid-column:1/-1">
            <div style="display:flex;gap:8px;margin-bottom:8px">
              <input id="linkTitulo" placeholder="Título do link">
              <input id="linkURL" placeholder="https://...">
              <button type="button" class="tabs" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff" id="addLink">Adicionar link</button>
            </div>
            <ul id="linksTmp" class="small muted"></ul>
          </div>

          <div style="grid-column:1/-1"><div class="pill">Metas</div></div>
          <div><label class="field">Meta de inscritos</label><input id="metaInscritos" type="number" placeholder="100000"></div>
          <div><label class="field">Prazo da meta (YYYY-MM-DD)</label><input id="metaPrazo" placeholder="2026-06-01"></div>
          <div><label class="field">Meta ritmo semanal (vídeos)</label><input id="metaRitmo" type="number" value="1"></div>
        </form>

        <div class="row">
          <button type="button" id="saveBtn" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff">Salvar/Adicionar</button>
          <button type="button" id="clearBtn" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff">Limpar</button>
          <button type="button" id="exportBtn" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff">Exportar JSON</button>
          <label for="importFile" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff;cursor:pointer">Importar JSON
            <input id="importFile" type="file" accept=".json" style="display:none">
          </label>
          <button type="button" id="wipeBtn" style="padding:8px 12px;border-radius:10px;background:#151e2c;border:1px solid var(--line);color:#cfe6ff">Limpar armazenamento</button>
        </div>

        <table style="margin-top:14px">
          <thead><tr><th>Título</th><th>Selo</th><th>Data</th><th>Status</th><th>Ações</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>

    <!-- PESQUISA -->
    <section id="panel-pesquisa">
      <div class="card">
        <div class="pill">Expositor de links</div>
        <ul id="listaPesquisa" class="list"></ul>
      </div>
    </section>

    <!-- ROTEIROS -->
    <section id="panel-roteiros">
      <div class="card">
        <div class="pill">Roteiros anexados</div>
        <ul id="listaRoteiros" class="list"></ul>
      </div>
    </section>

    <!-- FONTES -->
    <section id="panel-fontes">
      <div class="card">
        <div class="pill">Repositório de fontes</div>
        <ul id="listaFontes" class="list"></ul>
      </div>
    </section>

    <!-- METAS -->
    <section id="panel-metas">
      <div class="card">
        <div class="pill">Metas do mês</div>
        <div id="metasResumo" class="small muted">—</div>
      </div>
      <div class="card">
        <div class="pill">Ritmo semanal</div>
        <div id="barsMetas" class="bars"></div>
      </div>
    </section>

    <!-- HISTÓRICO -->
    <section id="panel-historico">
      <div class="card">
        <div class="pill">Histórico mensal</div>
        <ul id="listaHistorico" class="list"></ul>
      </div>
    </section>
  </div>
</section>

<!-- JS externo (sem inline; compatível com CSP) -->
<script defer src="app.js"></script>
</body>
</html>
// ---------- util ----------
const tz="America/Fortaleza", locale="pt-BR";
const LS="candieiro_";
const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);
const fmt = (d)=> new Intl.DateTimeFormat(locale,{timeZone:tz,weekday:'short',day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'}).format(d).replace(',','');
function parseISOLocal(s){const [d,t]=(s||"").split("T"); if(!d||!t) return null; const [Y,M,D]=d.split("-").map(Number); const [h,m]=t.split(":").map(Number); return new Date(Date.UTC(Y,(M||1)-1,(D||1),(h||0)+3,(m||0)||0,0))}
function human(ms){const s=Math.max(0,Math.floor(ms/1000));const d=Math.floor(s/86400);const h=Math.floor((s%86400)/3600);const m=Math.floor((s%3600)/60);const ss=s%60;return `${d}d ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(ss).padStart(2,'0')}`}

// ---------- dados ----------
let productions = [];
let metas = { mes:"2025-11", alvos:{narrativas:2, arquivo:2, inexplicavel:1, previas:2}, inscritos:{alvo:100000,prazo:"2026-06-01"}, ritmoSemanas:[1,0,2,1,0,1] };
let historico = [];

const STAGES = [
  { key:"pesquisa",  label:"Pesquisa",   dias:1 },
  { key:"roteiro",   label:"Roteiro",    dias:2 },
  { key:"gravacao",  label:"Gravação",   dias:1 },
  { key:"decupagem", label:"Decupagem",  dias:2 },
  { key:"edicao",    label:"Edição",     dias:3 },
  { key:"postagem",  label:"Postagem",   dias:0 },
];
function stageLabel(p){ for(const s of STAGES){ if(!(p.stages?.[s.key]?.done)) return s.label } return "Concluído" }

// ---------- persistência ----------
function saveAll(){
  localStorage.setItem(LS+"productions", JSON.stringify(productions.map(p=>({...p, when:undefined}))));
  localStorage.setItem(LS+"metas", JSON.stringify(metas));
  localStorage.setItem(LS+"historico", JSON.stringify(historico));
}
function loadAll(){
  const p = JSON.parse(localStorage.getItem(LS+"productions")||"[]");
  productions = p.map(x=>({...x, when:parseISOLocal(x.data)})).filter(x=>x.when && !isNaN(x.when));
  metas = JSON.parse(localStorage.getItem(LS+"metas")||"null") || metas;
  historico = JSON.parse(localStorage.getItem(LS+"historico")||"[]") || [];
}

// ---------- render ----------
function setBars(id, arr){
  const wrap=$(id.startsWith('#')?id:'#'+id); wrap.innerHTML="";
  const max=Math.max(...arr,1);
  arr.forEach(v=>{
    const h=Math.round((v/max)*110)+10;
    const col=document.createElement('div'); col.className="col"+(v? "":" muted"); col.style.height=h+"px"; col.innerHTML=`<small>${v}</small>`;
    wrap.appendChild(col);
  });
}
function renderSteps(p){
  const box=$("#steps"); box.innerHTML="";
  STAGES.forEach(s=>{
    const st=p.stages?.[s.key]||{};
    const done=!!st.done;
    const div=document.createElement('div'); div.className="step";
    const title=document.createElement('div'); title.className="s-title"; title.textContent=s.label;
    const time=document.createElement('div'); time.className="s-time";
    let spent="—";
    if(st.start){ const start=new Date(st.start); const end=done? new Date(st.end): new Date(); spent=human(end-start); }
    time.textContent=spent;
    if(done) div.style.background="linear-gradient(180deg,#13212f,#0d161f)";
    div.append(title,time); box.appendChild(div);
  });
}
function timeline(){
  const ul=$("#timeline"); ul.innerHTML="";
  [...productions].sort((a,b)=>a.when-b.when).forEach(p=>{
    const li=document.createElement('li');
    li.innerHTML=`<div><strong>${p.title}</strong><div class="small muted">${fmt(p.when)} · ${p.selo}</div></div>`;
    ul.appendChild(li);
  });
}
function counters(){
  const now=new Date();
  const sorted=[...productions].sort((a,b)=>a.when-b.when);
  const next=sorted.find(p=>p.when>now) || sorted[sorted.length-1];
  const prevs=sorted.filter(p=>p.when<=now); const prev=prevs.length? prevs[prevs.length-1]:null;
  $("#countdown").textContent=next? human(next.when-now):"--:--:--";
  $("#nextLabel").textContent=next? `Próximo: ${next.title} • ${fmt(next.when)}`:"Sem próximos eventos";
  const pg=$("#progress"), pgl=$("#progressLabel");
  if(prev && next){
    const total=next.when-prev.when; const pass=now-prev.when; const pct=Math.min(100,Math.max(0,(pass/total)*100));
    pg.style.width=pct.toFixed(1)+"%"; pgl.textContent=`Desde “${prev.title}” até “${next.title}” • ${pct.toFixed(1)}%`;
  }else{ pg.style.width="0%"; pgl.textContent="Aguardando primeiro lançamento." }
}
function flowStatus(){
  const flow={pesquisa:0,roteiro:0,gravacao:0,decupagem:0,edicao:0,postagem:0};
  productions.forEach(p=>{
    for(const s of STAGES){ if(!p.stages?.[s.key]?.done){ flow[s.key]++; break; } }
  });
  const ul=$("#flowList"); ul.innerHTML="";
  STAGES.forEach(s=>{
    const li=document.createElement('li'); li.textContent=`${s.label}: ${flow[s.key]}`; ul.appendChild(li);
  });
}
function renderRoteiros(){
  const ul=$("#listaRoteiros"); ul.innerHTML="";
  productions.forEach((p,i)=>{
    if(p.roteiro && (p.roteiro.pdfName || p.roteiro.pdfData)){
      const li=document.createElement('li');
      li.innerHTML=`<div><strong>${p.title}</strong> · ${p.selo}</div>`;
      ul.appendChild(li);
    }
  });
}
function renderFontes(){
  const list=[]; productions.forEach(p=> (p.links||[]).forEach(l=>list.push({...l,tema:p.title})));
  const lf=$("#listaFontes"), lp=$("#listaPesquisa"); lf.innerHTML=""; lp.innerHTML="";
  list.forEach(f=>{
    const html=`<div><strong>${f.titulo||"Fonte"}</strong> · <span class="muted">${f.tema}</span></div>
                <div><a href="${f.url}" target="_blank" rel="noopener">Abrir</a></div>`;
    const li1=document.createElement('li'); li1.innerHTML=html; lf.appendChild(li1);
    const li2=document.createElement('li'); li2.innerHTML=html; lp.appendChild(li2);
  });
}
function renderMetas(){
  $("#metasResumo").textContent = `Alvos — Narrativas: ${metas.alvos.narrativas} · Arquivo: ${metas.alvos.arquivo} · Inexplicável: ${metas.alvos.inexplicavel} · Prévias: ${metas.alvos.previas}`;
  setBars("barsMetas", metas.ritmoSemanas||[0,0,0,0,0,0]);
}
function renderTable(){
  const tb=$("#tblBody"); tb.innerHTML="";
  productions.sort((a,b)=>a.when-b.when).forEach((p,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${p.title}</td>
      <td>${p.selo}</td>
      <td>${fmt(p.when)}</td>
      <td>${stageLabel(p)}</td>
      <td>
        <button data-i="${i}" data-act="toggle">✓ Etapa concluída</button>
        <button data-i="${i}" data-act="del">Excluir</button>
      </td>`;
    tb.appendChild(tr);
  });
}
function renderSelect(){
  const sel=$("#selProd"); sel.innerHTML="";
  productions.sort((a,b)=>a.when-b.when).forEach((p,i)=>{
    const o=document.createElement('option'); o.value=i; o.textContent=`${fmt(p.when)} — ${p.title}`; sel.appendChild(o);
  });
  sel.onchange=()=>{ const p=productions[+sel.value]; p && renderSteps(p); };
  if(productions.length){ sel.value=0; renderSteps(productions[0]); }
}
function renderAll(){
  renderSelect(); timeline(); counters(); flowStatus(); setBars("bars",[1,0,2,1,0,1]);
  renderRoteiros(); renderFontes(); renderMetas();
}

// ---------- editor ----------
let tempLinks=[];
function renderTempLinks(){
  const ul=$("#linksTmp"); ul.innerHTML="";
  tempLinks.forEach(l=>{ const li=document.createElement('li'); li.innerHTML=`${l.titulo||"link"} · <a href="${l.url}" target="_blank">${l.url}</a>`; ul.appendChild(li); });
}
$("#addLink").onclick=()=>{
  const t=$("#linkTitulo").value.trim(), u=$("#linkURL").value.trim();
  if(!u) return; tempLinks.push({titulo:t,url:u}); renderTempLinks(); $("#linkTitulo").value=""; $("#linkURL").value="";
};
function stageObj(id){ const chk=$("#"+id).checked; return {done:chk,start:new Date().toISOString(),end: chk?new Date().toISOString():null}; }
function resetForm(){ $("#form").reset(); tempLinks=[]; renderTempLinks(); }

$("#saveBtn").onclick=()=>{
  const t=$("#fTitulo").value.trim(), s=$("#fSelo").value.trim(), d=$("#fData").value.trim();
  if(!t||!s||!d){ alert("Preencha título, selo e data"); return; }
  const p={
    title:t, selo:s, data:d, when:parseISOLocal(d),
    link: $("#fLink").value.trim()||"",
    stages:{
      pesquisa:stageObj('wPesquisa'), roteiro:stageObj('wRoteiro'),
      gravacao:stageObj('wGravacao'), decupagem:stageObj('wDecupagem'),
      edicao:stageObj('wEdicao'), postagem:stageObj('wPostagem'),
    },
    roteiro:{ notas:$("#fNotas").value.trim(),
      av:{forca:+$("#rForca").value||0, emocional:+$("#rEmocional").value||0, drama:+$("#rDrama").value||0, cred:+$("#rCred").value||0, orig:+$("#rOrig").value||0}
    },
    links:[...tempLinks]
  };
  const file=$("#fPDF").files[0];
  if(file){
    const fr=new FileReader();
    fr.onload=()=>{ p.roteiro.pdfName=file.name; p.roteiro.pdfData=(fr.result||"").split(",")[1]||""; finish(); };
    fr.readAsDataURL(file);
  }else finish();

  function finish(){ productions.push(p); saveAll(); resetForm(); renderAll(); renderTable(); }
};
$("#clearBtn").onclick=resetForm;
$("#exportBtn").onclick=()=>{
  const blob=new Blob([JSON.stringify({productions,metas,historico},null,2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="candieiro-export.json"; a.click();
};
$("#importFile").onchange = (e)=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader(); r.onload=()=>{ const j=JSON.parse(r.result||"{}"); productions=(j.productions||[]).map(p=>({...p,when:parseISOLocal(p.data)})); metas=j.metas||metas; historico=j.historico||[]; saveAll(); renderAll(); renderTable(); };
  r.readAsText(f);
};
$("#wipeBtn").onclick=()=>{ if(confirm("Apagar armazenamento local?")){ localStorage.removeItem(LS+"productions"); localStorage.removeItem(LS+"metas"); localStorage.removeItem(LS+"historico"); productions=[]; loadDefaults(); renderAll(); renderTable(); } };

$("#tblBody").onclick=(e)=>{
  const b=e.target.closest('button[data-i]'); if(!b) return;
  const i=+b.dataset.i, act=b.dataset.act;
  if(act==="del"){ if(confirm("Excluir produção?")){ productions.splice(i,1); saveAll(); renderAll(); renderTable(); } }
  if(act==="toggle"){ const p=productions[i]; for(const s of STAGES){ if(!p.stages?.[s.key]?.done){ p.stages[s.key]={done:true,start:p.stages[s.key]?.start||new Date().toISOString(),end:new Date().toISOString()}; break;} } saveAll(); renderAll(); renderTable(); }
};

// ---------- defaults (Out/Nov) ----------
function loadDefaults(){
  if(productions.length) return;
  productions = [
    {title:"Arquivo Criminal: Ed Gein",     selo:"Arquivo Criminal", data:"2025-10-01T18:00"},
    {title:"Narrativas: Caso Genivaldo",    selo:"Narrativas",        data:"2025-10-17T18:00"},
    {title:"Narrativas: Aberfan",           selo:"Narrativas",        data:"2025-10-31T18:00"},
    {title:"Inexplicável: Quarto 1046",     selo:"Inexplicável",      data:"2025-11-10T18:00"},
    {title:"Narrativas: Chico Mendes",      selo:"Narrativas",        data:"2025-11-14T18:00"},
    {title:"Arquivo Criminal: Amelia Dyer", selo:"Arquivo Criminal",  data:"2025-11-21T18:00"}
  ].map(x=>({...x, when:parseISOLocal(x.data), stages:{}}));
  historico = [
    { mes:"2025-10", publicados:["Arquivo Criminal: Ed Gein","Narrativas: Caso Genivaldo","Narrativas: Aberfan"] },
    { mes:"2025-11", publicados:[] }
  ];
  metas = { mes:"2025-11", alvos:{narrativas:2, arquivo:2, inexplicavel:1, previas:2}, inscritos:{alvo:100000,prazo:"2026-06-01"}, ritmoSemanas:[1,0,2,1,0,1] };
  saveAll();
}

// ---------- boot ----------
function boot(){
  loadAll(); loadDefaults(); renderAll(); renderTable(); setInterval(counters,1000);
}
document.addEventListener('DOMContentLoaded', boot);
