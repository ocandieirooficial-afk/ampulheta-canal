<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Est√∫dios Candieiro ‚Äî Painel de Produ√ß√£o</title>
<meta name="color-scheme" content="dark light">
<link rel="icon" href="/assets/logo.png">
<style>
  :root{
    --bg:#0b0e13; --panel:#121720; --ink:#e9edf3; --muted:#9fb0c8;
    --accent:#ffcc00; --accent2:#fff07a; --line:#1f2a3d; --ok:#39d98a; --warn:#ffd166; --bad:#ff6b6b;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif; background:radial-gradient(1200px 800px at 75% 0%, rgba(218,45,64,.06), rgba(0,0,0,0)), linear-gradient(160deg,#0b0e13 0%, #151820 55%, #1a202b 100%); color:var(--ink)}
  .wrap{max-width:980px; margin:28px auto 48px; padding:0 16px}
  header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:16px}
  .brand{display:flex; align-items:center; gap:12px}
  .logo-img{width:36px; height:36px; border-radius:8px; object-fit:cover}
  h1{font-size:22px; margin:0}
  .sub{color:var(--muted); font-size:13px}
  .right{display:flex; align-items:center; gap:10px}
  .avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)}
  nav{display:flex; gap:8px; flex-wrap:wrap}
  .tab{background:#151e2c; border:1px solid var(--line); color:#cfe6ff; padding:8px 12px; border-radius:10px; cursor:pointer}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#222; border-color:#d4b100}
  .card{background:var(--panel); border:1px solid var(--line); border-radius:16px; padding:18px; margin-bottom:16px; box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .row{display:flex; gap:16px; flex-wrap:wrap}
  .row .card{flex:1 1 280px}
  .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#0f1420; border:1px solid var(--line); color:#9fb0c8; font-size:12px}
  .big{font-size:34px; font-weight:800; letter-spacing:.2px}
  .bar{height:12px; background:#0e1420; border:1px solid var(--line); border-radius:999px; overflow:hidden}
  .bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--accent),var(--accent2)); transition:width .6s ease}
  .grid2{display:grid; grid-template-columns:1fr 1fr; gap:16px}
  @media (max-width:860px){ .grid2{grid-template-columns:1fr} .big{font-size:28px} }
  ul.list{list-style:none; padding:0; margin:0}
  .list li{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 0; border-bottom:1px dashed #223046}
  .list li:last-child{border-bottom:none}
  .when{color:#9fb0c8; font-size:14px}
  .tag{font-size:12px; padding:6px 10px; border-radius:999px; border:1px solid #23314a; background:#0a111d; color:#cfd6e6}
  .muted{color:#9fb0c8} .small{font-size:12px}
  button,.btn{background:#152238; color:#cfe6ff; border:1px solid #254064; padding:10px 14px; border-radius:10px; cursor:pointer}
  button:hover,.btn:hover{filter:brightness(1.08)}
  input,select{width:100%; background:#0e1420; color:#cfe6ff; border:1px solid var(--line); border-radius:10px; padding:10px}
  label{font-size:12px; color:#9fb0c8}
  .controls{display:flex; gap:8px; flex-wrap:wrap}
  .controls .btn{padding:8px 10px}
  table{width:100%; border-collapse:collapse; font-size:14px}
  th,td{padding:10px; border-bottom:1px dashed #223046; text-align:left}
  th{color:#a9bdd7; font-weight:600}
  .view{display:none} .view.active{display:block}
  .footer{margin-top:16px; font-size:12px; color:#8aa0bf}

  /* ---- Metas Visuais ---- */
  .meta-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
  @media (max-width:860px){ .meta-grid{grid-template-columns:1fr} }
  .donut{
    --size:160; --stroke:12; --circ: calc(3.14159 * (var(--size) - var(--stroke)));
    display:flex; align-items:center; gap:12px;
  }
  .donut svg{width:var(--size)px; height:var(--size)px}
  .donut .kpi{display:flex; flex-direction:column; gap:2px}
  .kpi .value{font-size:28px; font-weight:800}
  .kpi .label{font-size:13px; color:#9fb0c8}
  .donut .bg{stroke:#1f2938; opacity:.9}
  .donut .fg{stroke:url(#g1); transition:stroke-dashoffset .7s ease}
  .legend{display:flex; align-items:center; gap:8px; font-size:12px; color:#9fb0c8}
  .legend i{display:inline-block; width:12px; height:12px; border-radius:3px}

  .stack{height:18px; border:1px solid var(--line); border-radius:999px; overflow:hidden; background:#0e1420; display:flex}
  .stack .seg{height:100%}
  .seg.g{background:linear-gradient(90deg, #2fe3a1, #8ef4cd)}
  .seg.e{background:linear-gradient(90deg, #ffd166, #ffe9a6)}
  .seg.p{background:linear-gradient(90deg, #6dc1ff, #a9d8ff)}

  .bars{display:flex; gap:8px; align-items:flex-end; height:120px; margin-top:8px}
  .bars .col{flex:1; background:linear-gradient(180deg, #ffcc00, #ffd84d); border:1px solid #d7b000; border-radius:6px 6px 0 0; min-width:28px; display:flex; align-items:flex-end; justify-content:center; color:#1d1700; font-weight:700}
  .bars .col small{display:block; padding:6px 2px}
  .bars .col.muted{background:linear-gradient(180deg, #243146, #1a232f); border-color:#1f2a3d; color:#a9bdd7}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <img class="logo-img" src="/assets/logo.png" alt="Est√∫dios Candieiro">
        <div>
          <h1>Est√∫dios Candieiro</h1>
          <div class="sub">Painel de Produ√ß√£o ‚Äî America/Fortaleza</div>
        </div>
      </div>
      <div class="right">
        <img class="avatar" src="/assets/paulo.jpg" alt="Paulo Henrique Leit√£o">
      </div>
    </header>

    <nav>
      <button class="tab active" data-view="dashboard">Dashboard</button>
      <button class="tab" data-view="editor">Editor</button>
      <button class="tab" data-view="pesquisa">Pesquisa</button>
      <button class="tab" data-view="roteiros">Roteiros</button>
      <button class="tab" data-view="fontes">Fontes</button>
      <button class="tab" data-view="metas">Metas</button>
      <button class="tab" data-view="historico">Hist√≥rico</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboard" class="view active">
      <div class="row">
        <div class="card">
          <div class="pill">Pr√≥ximo v√≠deo em</div>
          <div id="countdown" class="big" style="margin:8px 0 6px">--:--:--</div>
          <div class="muted small" id="nextLabel">Carregando‚Ä¶</div>
        </div>
        <div class="card">
          <div class="pill">Progresso entre lan√ßamentos</div>
          <div class="bar" style="margin:10px 0 8px"><span id="progress"></span></div>
          <div class="muted small" id="progressLabel">‚Äî</div>
        </div>
      </div>

      <!-- Metas Visuais (resumo) -->
      <div class="card">
        <div class="pill">Metas do m√™s ‚Äî Vis√£o r√°pida</div>
        <div id="metasResumo" class="meta-grid" style="margin-top:12px"></div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="pill">Linha do tempo</div>
          <ul class="list" id="timeline"></ul>
        </div>
        <div class="card">
          <div class="pill">Dicas r√°pidas</div>
          <p class="small muted" style="margin-top:10px">
            ‚Ä¢ Verde = ritmo bom. ‚Ä¢ Se a barra travar &lt; 50% perto do prazo, mova tarefas do ‚ÄúEditor‚Äù para o decupador.<br/>
            ‚Ä¢ Cronograma fixo: Seg(üåÄ), Ter(Pr√©via), Qua(Arquivo Criminal), Qui(Abertos), Sex(Narrativas) ‚Äî 18h.
          </p>
        </div>
      </div>
      <p class="footer">¬© Est√∫dios Candieiro ‚Äî Painel interno de produ√ß√£o.</p>
    </section>

    <!-- EDITOR -->
    <section id="editor" class="view">
      <div class="card">
        <div class="pill">Gerenciar lan√ßamentos (autosave em Cloudflare KV)</div>
        <div style="margin:10px 0 12px" class="controls">
          <button id="addSample" class="btn">Carregar exemplo (Out/Nov)</button>
          <button id="exportBtn" class="btn">Exportar JSON</button>
          <label for="importFile" class="btn">Importar JSON<input id="importFile" type="file" accept=".json" style="display:none"></label>
          <button id="syncLoad" class="btn">Recarregar do servidor</button>
          <button id="syncSave" class="btn">For√ßar salvar no servidor</button>
        </div>

        <form id="form" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px">
          <div><label>T√≠tulo</label><input id="fTitulo" placeholder="Narrativas: Chico Mendes"></div>
          <div><label>Selo</label>
            <select id="fSelo"><option>Narrativas</option><option>Arquivo Criminal</option><option>Inexplic√°vel</option><option>Pr√©via</option><option>Abertos</option></select>
          </div>
          <div><label>Data & hora (YYYY-MM-DDTHH:MM)</label><input id="fData" placeholder="2025-11-14T18:00"></div>
          <div class="right">
            <button type="button" id="saveBtn" class="btn">Salvar/Adicionar</button>
            <button type="button" id="clearBtn" class="btn danger">Limpar tudo</button>
          </div>
        </form>

        <table>
          <thead><tr><th>T√≠tulo</th><th>Selo</th><th>Data (Fortaleza)</th><th>A√ß√µes</th></tr></thead>
          <tbody id="tblBody"></tbody>
        </table>
      </div>
    </section>

    <!-- PESQUISA -->
    <section id="pesquisa" class="view"><div class="card"><div class="pill">Pesquisa</div>
      <input id="qPesquisa" placeholder="Buscar por tema/roteiro..." style="margin:10px 0">
      <ul class="list" id="listaPesquisa"></ul>
    </div></section>

    <!-- ROTEIROS -->
    <section id="roteiros" class="view"><div class="card"><div class="pill">Roteiros</div>
      <ul class="list" id="listaRoteiros"></ul>
    </div></section>

    <!-- FONTES -->
    <section id="fontes" class="view"><div class="card"><div class="pill">Fontes & Refer√™ncias</div>
      <ul class="list" id="listaFontes"></ul>
    </div></section>

    <!-- METAS (detalhes visuais) -->
    <section id="metas" class="view">
      <div class="card">
        <div class="pill">Metas do m√™s (visuais)</div>
        <div id="metasVisual" class="meta-grid" style="margin-top:12px"></div>
      </div>

      <div class="grid2">
        <div class="card">
          <div class="pill">Produ√ß√£o (Gravados / Editando / Publicados)</div>
          <div id="stackWrap" style="margin-top:8px">
            <div class="stack">
              <div class="seg g" id="segG" style="width:0%"></div>
              <div class="seg e" id="segE" style="width:0%"></div>
              <div class="seg p" id="segP" style="width:0%"></div>
            </div>
            <p class="small muted" id="stackLabel" style="margin-top:8px">‚Äî</p>
          </div>
        </div>

        <div class="card">
          <div class="pill">Ritmo semanal</div>
          <div id="bars" class="bars"></div>
          <p class="small muted" style="margin-top:6px">Publica√ß√µes por semana (√∫ltimas 6 semanas)</p>
        </div>
      </div>
    </section>

    <!-- HIST√ìRICO -->
    <section id="historico" class="view"><div class="card"><div class="pill">Hist√≥rico mensal</div>
      <ul class="list" id="listaHistorico"></ul>
    </div></section>
  </div>

<script>
/* ===== Persist√™ncia compartilhada (KV) ===== */
const STORE_URL = "/api/store?key=";
async function loadShared(key, fallback = {}) {
  try { const r = await fetch(STORE_URL + encodeURIComponent(key), { cache:"no-store" });
        if(!r.ok) throw 0; return await r.json(); } catch { return fallback; }
}
async function saveShared(key, data) {
  await fetch(STORE_URL + encodeURIComponent(key), {
    method:"PUT", headers:{ "content-type":"application/json" }, body:JSON.stringify(data)
  });
}

/* ===== Estado e helpers ===== */
const tz = "America/Fortaleza";
const locale = "pt-BR";

let events = [];
let roteiros = [];
let fontes = [];
let metas = { mes:"2025-11", alvos:{videos_premium:4, previas:2, inexplicavel:1}, producao:{gravados:0, editando:0, publicados:0}, ritmoSemanas:[0,0,0,0,0,0] };
let historico = [];

function parseISOLocal(s){
  const [d,t]= (s||"").split("T"); if(!d||!t) return null;
  const [Y,M,D]=d.split("-").map(Number); const [h,m]=t.split(":").map(Number);
  return new Date(Date.UTC(Y,(M||1)-1,D||1,(h||0)+3,(m||0)||0,0)); // Fortaleza ~ UTC-3
}
function fmtDate(d){
  return new Intl.DateTimeFormat(locale, {
    timeZone: tz, weekday:'short', day:'2-digit', month:'2-digit', year:'numeric',
    hour:'2-digit', minute:'2-digit'
  }).format(d).replace(',', '');
}
function humanDiff(ms){
  const s = Math.max(0, Math.floor(ms/1000));
  const dd = Math.floor(s/86400);
  const hh = Math.floor((s%86400)/3600);
  const mm = Math.floor((s%3600)/60);
  const ss = s%60;
  return `${dd}d ${String(hh).padStart(2,'0')}:${String(mm).padStart(2,'0')}:${String(ss).padStart(2,'0')}`;
}
function between(a,b,now){
  const total = b - a;
  const passed = Math.max(0, now - a);
  return { total, passed, pct: total>0 ? Math.min(100, Math.max(0, (passed/total)*100)) : 100 };
}

/* ===== Dashboard ===== */
function renderTimeline(now){
  const ul=document.getElementById('timeline'); ul.innerHTML='';
  [...events].sort((a,b)=>a.when-b.when).forEach(e=>{
    const li=document.createElement('li');
    const left=document.createElement('div');
    left.innerHTML=`<strong>${e.titulo}</strong><div class="when">${fmtDate(e.when)} ¬∑ ${e.selo}</div>`;
    const right=document.createElement('div');
    const tag=document.createElement('span'); tag.className='tag';
    const delta=e.when-now; tag.textContent = delta>0 ? `em ${humanDiff(delta)}` : `h√° ${humanDiff(-delta)}`;
    right.appendChild(tag); li.append(left,right); ul.appendChild(li);
  });
}
function renderCounters(){
  const now=new Date();
  const sorted=[...events].sort((a,b)=>a.when-b.when);
  const next = sorted.find(e => e.when > now) || sorted[sorted.length-1];
  const prevs = sorted.filter(e => e.when <= now);
  const prev = prevs.length ? prevs[prevs.length-1] : null;

  const cd=document.getElementById('countdown');
  const lbl=document.getElementById('nextLabel');
  cd.textContent = next ? humanDiff(next.when - now) : "--:--:--";
  lbl.textContent = next ? `Pr√≥ximo: ${next.titulo} ‚Ä¢ ${fmtDate(next.when)}` : "Sem pr√≥ximos eventos";

  const pg=document.getElementById('progress');
  const pgl=document.getElementById('progressLabel');
  if(prev && next){
    const met=between(prev.when,next.when,now);
    pg.style.width=met.pct.toFixed(1)+'%';
    pgl.textContent=`Desde ‚Äú${prev.titulo}‚Äù at√© ‚Äú${next.titulo}‚Äù ‚Ä¢ ${met.pct.toFixed(1)}% conclu√≠do`;
  }else{
    pg.style.width='0%'; pgl.textContent='Aguardando primeiro lan√ßamento.';
  }
  renderTimeline(now);
}

/* ===== Editor + sync ===== */
const KEY_EVENTS="events", KEY_ROTEIROS="roteiros", KEY_FONTES="fontes",
      KEY_METAS="metas", KEY_HIST="historico";

async function loadAll(){
  const [ev, rt, ft, mt, hi] = await Promise.all([
    loadShared(KEY_EVENTS, []),
    loadShared(KEY_ROTEIROS, []),
    loadShared(KEY_FONTES, []),
    loadShared(KEY_METAS, metas),
    loadShared(KEY_HIST, [])
  ]);
  events=(ev||[]).map(e=>({ ...e, when: parseISOLocal(e.data) })).filter(e=>e.when && !isNaN(e.when));
  roteiros=rt||[]; fontes=ft||[]; metas=mt||metas; historico=hi||[];
}
async function saveAll(){
  await Promise.all([
    saveShared(KEY_EVENTS, events.map(e=>({titulo:e.titulo,selo:e.selo,data:e.data}))),
    saveShared(KEY_ROTEIROS, roteiros),
    saveShared(KEY_FONTES, fontes),
    saveShared(KEY_METAS, metas),
    saveShared(KEY_HIST, historico)
  ]);
}
function renderTable(){
  const tbody = document.getElementById("tblBody"); tbody.innerHTML="";
  events.sort((a,b)=>a.when-b.when).forEach((e,i)=>{
    const tr=document.createElement("tr");
    tr.innerHTML = `
      <td>${e.titulo}</td>
      <td>${e.selo}</td>
      <td>${fmtDate(e.when)}</td>
      <td>
        <button class="btn" data-action="edit" data-i="${i}">Editar</button>
        <button class="btn danger" data-action="del" data-i="${i}">Excluir</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

/* Import/Export */
document.getElementById('exportBtn')?.addEventListener('click', ()=>{
  const blob=new Blob([JSON.stringify(events.map(e=>({titulo:e.titulo,selo:e.selo,data:e.data})), null, 2)],{type:"application/json"});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download="candieiro-events.json"; a.click();
});
document.getElementById('importFile')?.addEventListener('change', async (ev)=>{
  const f=ev.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{ 
    const arr=JSON.parse(r.result||"[]");
    events = arr.map(e=>({ ...e, when: parseISOLocal(e.data) })).filter(e=>e.when && !isNaN(e.when));
    await saveAll(); rerender();
  };
  r.readAsText(f);
});

/* Toolbar ‚Äì sync */
document.getElementById('syncLoad')?.addEventListener('click', async ()=>{ await loadAll(); rerender(); });
document.getElementById('syncSave')?.addEventListener('click', async ()=>{ await saveAll(); alert("Dados salvos no servidor (KV)."); });

/* Add/Edit/Delete */
document.getElementById('saveBtn')?.addEventListener('click', async ()=>{
  const t=document.getElementById('fTitulo').value.trim();
  const s=document.getElementById('fSelo').value.trim();
  const d=document.getElementById('fData').value.trim();
  const when=parseISOLocal(d);
  if(!t||!s||!when||isNaN(when)){ alert("Preencha t√≠tulo, selo e data (YYYY-MM-DDTHH:MM)"); return; }
  events.push({titulo:t,selo:s,data:d,when}); await saveAll(); rerender();
  document.getElementById('form').reset();
});
document.getElementById('tblBody')?.addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const i=+btn.dataset.i;
  if(btn.dataset.action==='del'){ events.splice(i,1); await saveAll(); rerender(); }
  if(btn.dataset.action==='edit'){
    const item=events[i];
    document.getElementById('fTitulo').value=item.titulo;
    document.getElementById('fSelo').value=item.selo;
    document.getElementById('fData').value=item.data;
    events.splice(i,1); await saveAll(); rerender();
  }
});
document.getElementById('clearBtn')?.addEventListener('click', async ()=>{
  if(confirm("Apagar todos os eventos?")){ events=[]; await saveAll(); rerender(); }
});

/* ===== Metas Visuais ===== */
function donutCard(titulo, valor, alvo, id){
  const pct = alvo ? Math.max(0, Math.min(100, (valor/alvo)*100)) : 100;
  const size=160, stroke=12, radius=(size-stroke)/2, circ=2*Math.PI*radius, dash=circ*(1-pct/100);
  return `
  <div class="donut">
    <svg viewBox="0 0 ${size} ${size}">
      <defs>
        <linearGradient id="g1" x1="0" x2="1">
          <stop offset="0%" stop-color="#ffcc00"/><stop offset="100%" stop-color="#fff07a"/>
        </linearGradient>
      </defs>
      <circle class="bg" cx="${size/2}" cy="${size/2}" r="${radius}" stroke-width="${stroke}" fill="none"/>
      <circle class="fg" id="${id}" cx="${size/2}" cy="${size/2}" r="${radius}" stroke-width="${stroke}" fill="none"
              stroke-dasharray="${circ}" stroke-dashoffset="${dash}" transform="rotate(-90 ${size/2} ${size/2})"/>
      <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" fill="#e9edf3" font-size="18" font-weight="700">${Math.round(pct)}%</text>
    </svg>
    <div class="kpi">
      <div class="value">${valor} / ${alvo}</div>
      <div class="label">${titulo}</div>
      <div class="legend"><i style="background:#2fe3a1"></i>Progresso</div>
    </div>
  </div>`;
}
function renderMetasBlocks(whereId){
  const wrap=document.getElementById(whereId);
  const a = metas.alvos || {videos_premium:4, previas:2, inexplicavel:1};
  const p = metas.producao || {gravados:0, editando:0, publicados:0};
  const premiumPublicados = (historico.find(h=>h.mes===metas.mes)?.publicados||[])
                            .filter(t=>/Narrativas|Arquivo Criminal/i.test(t)).length || 0;
  const previasEstimadas = Math.min(a.previas, Math.round(p.editando/2)); // heur√≠stica simples
  const inexpPublicados = (historico.find(h=>h.mes===metas.mes)?.publicados||[])
                          .filter(t=>/Inexplic√°vel/i.test(t)).length || 0;

  wrap.innerHTML = `
    ${donutCard("Premium (Narrativas + Arquivo)", premiumPublicados, a.videos_premium, "d1")}
    ${donutCard("Pr√©vias", previasEstimadas, a.previas, "d2")}
    ${donutCard("Inexplic√°vel (1/m√™s)", inexpPublicados, a.inexplicavel, "d3")}
  `;

  // Barra empilhada (produ√ß√£o)
  const total = (p.gravados||0)+(p.editando||0)+(p.publicados||0) || 1;
  document.getElementById("segG").style.width = ((p.gravados||0)/total*100).toFixed(1)+"%";
  document.getElementById("segE").style.width = ((p.editando||0)/total*100).toFixed(1)+"%";
  document.getElementById("segP").style.width = ((p.publicados||0)/total*100).toFixed(1)+"%";
  document.getElementById("stackLabel").textContent =
    `Gravados: ${p.gravados||0} ¬∑ Editando: ${p.editando||0} ¬∑ Publicados: ${p.publicados||0}`;

  // Barras semanais
  const bars=document.getElementById("bars"); bars.innerHTML="";
  const arr=metas.ritmoSemanas || [0,0,0,0,0,0];
  const max=Math.max(...arr, 1);
  arr.forEach((v,i)=>{
    const h=Math.round((v/max)*110)+10;
    const col=document.createElement('div');
    col.className="col"+(v? "":" muted");
    col.style.height=h+"px";
    col.innerHTML = `<small>${v}</small>`;
    bars.appendChild(col);
  });
}

/* ===== Abas extra (cat√°logos) ===== */
function renderCatalogs(){
  const lf = document.getElementById("listaFontes"); lf.innerHTML="";
  fontes.forEach(f=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><strong>${f.titulo||"Fonte"}</strong> ¬∑ ${f.tipo||"‚Äì"} ¬∑ <span class="muted">${f.tema||""}</span></div>
    <div>${f.link?`<a class="btn" href="${f.link}" target="_blank" rel="noopener">Abrir</a>`:""}</div>`;
    lf.appendChild(li);
  });
  const lr = document.getElementById("listaRoteiros"); lr.innerHTML="";
  roteiros.forEach(r=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><strong>${r.titulo}</strong> ¬∑ ${r.selo} ¬∑ <span class="muted">${r.status||"‚Äì"}</span></div>
    <div>${r.arquivo ? `<a class="btn" href="${r.arquivo}" download>Baixar</a>` : ""}</div>`;
    lr.appendChild(li);
  });
  const q = document.getElementById("qPesquisa");
  const lp = document.getElementById("listaPesquisa"); lp.innerHTML="";
  function refreshSearch(){
    const term=(q.value||"").toLowerCase();
    lp.innerHTML="";
    fontes.filter(x=>JSON.stringify(x).toLowerCase().includes(term)).forEach(f=>{
      const li=document.createElement("li");
      li.innerHTML = `<div><strong>${f.titulo||"Fonte"}</strong> ¬∑ ${f.tipo||"‚Äì"} ¬∑ <span class="muted">${f.tema||""}</span></div>
      <div>${f.link?`<a class="btn" href="${f.link}" target="_blank" rel="noopener">Abrir</a>`:""}</div>`;
      lp.appendChild(li);
    });
  }
  q?.addEventListener("input", refreshSearch); refreshSearch();

  // Metas (detalhe + resumo)
  renderMetasBlocks("metasVisual");
  renderMetasBlocks("metasResumo");

  // Hist√≥rico
  const lh = document.getElementById("listaHistorico"); lh.innerHTML="";
  (historico||[]).forEach(m=>{
    const li = document.createElement("li");
    li.innerHTML = `<div><strong>${m.mes}</strong></div><div class="muted">${(m.publicados||[]).join(", ")||"‚Äî"}</div>`;
    lh.appendChild(li);
  });
}

/* ===== Amostra (Out/Nov) ===== */
function sampleFill(){
  events = [
    { titulo:"Arquivo Criminal: Ed Gein", selo:"Arquivo Criminal", data:"2025-10-01T18:00" },
    { titulo:"Narrativas: Caso Genivaldo", selo:"Narrativas", data:"2025-10-17T18:00" },
    { titulo:"Narrativas: Aberfan", selo:"Narrativas", data:"2025-10-31T18:00" },
    { titulo:"Inexplic√°vel: Quarto 1046 (estreia)", selo:"Inexplic√°vel", data:"2025-11-10T18:00" },
    { titulo:"Narrativas: Chico Mendes", selo:"Narrativas", data:"2025-11-14T18:00" },
    { titulo:"Arquivo Criminal: Amelia Dyer", selo:"Arquivo Criminal", data:"2025-11-19T18:00" },
    { titulo:"Narrativas: Anneliese Michel", selo:"Narrativas", data:"2025-11-28T18:00" }
  ].map(e=>({ ...e, when: parseISOLocal(e.data) }));
  roteiros = [
    {"titulo":"Chico Mendes","selo":"Narrativas","status":"finalizado","arquivo":"/downloads/chico-mendes.pdf"},
    {"titulo":"Caso Pesseghini","selo":"Arquivo Criminal","status":"em edi√ß√£o","arquivo":"/downloads/pesseghini.pdf"}
  ];
  fontes = [
    {"tema":"Chico Mendes","tipo":"artigo","titulo":"Reportagem X","link":"https://exemplo.com/x"},
    {"tema":"Ed Gein","tipo":"livro","titulo":"Deviant","link":"https://exemplo.com/livro"}
  ];
  metas = {
    "mes":"2025-11",
    "alvos":{"videos_premium":4,"previas":2,"inexplicavel":1},
    "producao":{"gravados":1,"editando":1,"publicados":0},
    "ritmoSemanas":[1,0,2,1,0,1]
  };
  historico = [{"mes":"2025-10","publicados":["Ed Gein","Genivaldo","Aberfan"]}];
}
document.getElementById('addSample')?.addEventListener('click', async ()=>{ sampleFill(); await saveAll(); rerender(); });

/* ===== Tabs ===== */
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
    document.getElementById(btn.dataset.view).classList.add('active');
  });
});

/* ===== Boot ===== */
async function boot(){
  await loadAll();
  if(!events.length){ sampleFill(); await saveAll(); }
  rerender();
}
function rerender(){ renderTable(); renderCounters(); renderCatalogs(); }
boot();
setInterval(renderCounters, 1000);
</script>
</body>
</html>
